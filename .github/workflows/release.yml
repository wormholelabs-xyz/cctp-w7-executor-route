name: Build and Package on Release

on:
    release:
        types: [created]

jobs:
    build-and-pack:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                node-version: '20'
                cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Update version in package.json
              run: |
                jq ".version = \"${{ github.event.release.tag_name }}\"" package.json > package.json.tmp
                mv package.json.tmp package.json

            - name: Build the project
              run: npm run build

            - name: Test the project
              run: npm run test

            - name: Package the project
              run: npm pack

            - name: Upload package
              run: |
                gh release upload ${{ github.event.release.tag_name }} *.tgz --clobber